name: check
on:
  pull_request:
  push:
    branches:
      - main

jobs:
  fmt-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Check Nix formatting
        run: nix fmt -- --check .
      - name: Run pre-commit checks
        run: nix flake check -L

  version-check:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Build package
        run: nix build -L
      - name: Verify binary version matches sources.json
        run: |
          # Determine the latest version key
          LATEST_VERSION=$(jq -r 'keys | sort | last' sources.json)
          echo "Latest version: $LATEST_VERSION"

          # Determine platform-specific key based on OS
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            PLATFORM="x86_64-linux"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            # Detect macOS architecture
            if [[ "$(uname -m)" == "arm64" ]]; then
              PLATFORM="aarch64-darwin"
            else
              PLATFORM="x86_64-darwin"
            fi
          else
            echo "❌ Unsupported OS: $RUNNER_OS"
            exit 1
          fi

          echo "Platform: $PLATFORM"

          # Extract expected version from sources.json for current platform
          EXPECTED_VERSION=$(jq -r --arg ver "$LATEST_VERSION" --arg platform "$PLATFORM" '.[$ver][$platform].actualBinaryVersion' sources.json)
          echo "Expected version from sources.json ($PLATFORM): $EXPECTED_VERSION"

          # Get actual version from built binary
          ACTUAL_VERSION=$(./result/bin/claude --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          echo "Actual binary version: $ACTUAL_VERSION"

          # Compare versions
          if [ "$EXPECTED_VERSION" != "$ACTUAL_VERSION" ]; then
            echo "❌ Version mismatch!"
            echo "  Expected: $EXPECTED_VERSION"
            echo "  Actual: $ACTUAL_VERSION"
            exit 1
          fi

          echo "✅ Version check passed: $ACTUAL_VERSION"
      - name: Display full version output
        run: |
          echo "Full version output from built binary:"
          ./result/bin/claude --version
